name: Update PoE2 prices

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch PoE2 currency JSON (diagnostic)
        run: |
          LEAGUE="Standard"
          URL="https://poe.ninja/poe2/api/data/currencyoverview?league=${LEAGUE}&type=Currency"
          echo "Fetching: $URL"

          # On force un User-Agent "navigateur"
          UA="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120 Safari/537.36"

          # Tentatives avec retry natif curl + affichage code HTTP
          for i in 1 2 3 4 5; do
            echo "Attempt $i..."

            HTTP_CODE=$(curl -L --retry 3 --retry-all-errors --connect-timeout 15 --max-time 30 \
              -A "$UA" -H "Accept: application/json" \
              -sS -w "%{h





      - name: Commit changes
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          git add data/prices.json
          git commit -m 'Update prices.json' || exit 0
          git push
